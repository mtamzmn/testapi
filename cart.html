<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>سلة المشتريات | مطعم الزمن القديم</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Cairo', sans-serif; background: #fefefe; color: #333; }
.navbar { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.navbar-brand { font-weight: 700; color: #d35400 !important; }


.cart-title { font-size: 2rem; font-weight: 700; margin-bottom: 30px; color: #d35400; text-align: center; }
.cart-table { background: #fff; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); padding: 20px; }
.cart-table th, .cart-table td { vertical-align: middle; text-align: center; }
.cart-table img { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; }
.btn-remove { background: #e74c3c; color: #fff; border: none; border-radius: 8px; padding: 5px 10px; }
.btn-remove:hover { background: #c0392b; }
.total-container { text-align: right; margin-top: 20px; font-size: 1.3rem; font-weight: bold; }
.checkout-btn { background: #d35400; color: #fff; border: none; padding: 12px 30px; font-size: 1.2rem; border-radius: 10px; margin-top: 20px; }
.checkout-btn:hover { background: #b84300; }
.clear-btn { background: #555; color: #fff; border: none; padding: 12px 20px; font-size: 1rem; border-radius: 10px; margin-top: 20px; margin-left: 10px; }
.clear-btn:hover { background: #333; }
.quantity-input { width: 70px; text-align: center; border-radius: 8px; border: 1px solid #ccc; }
.empty-cart { text-align: center; font-size: 1.5rem; color: #888; margin-top: 50px; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a class="navbar-brand" href="index.html"><i class="bi bi-house-door"></i> الرئيسية</a>
    <span class="ms-auto fs-5">سلة المشتريات</span>
  </div>
</nav>

<div class="container">
  <h2 class="cart-title">سلة مشترياتك</h2>
  
  <div id="cart-container"></div>

  <div class="text-end">
    <div class="total-container" id="total-price">إجمالي السعر: 0 ريال</div>
    <button class="checkout-btn" id="checkout-btn" onclick="proceedToCheckout()">إتمام الطلب</button>
    <button class="clear-btn" id="clear-cart-btn" onclick="clearCart()">افراغ السلة</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let cart = JSON.parse(localStorage.getItem('cart')) || [];

function displayCart() {
  const container = document.getElementById('cart-container');
  const totalPriceContainer = document.getElementById('total-price');
  const checkoutBtn = document.getElementById('checkout-btn');
  const clearBtn = document.getElementById('clear-cart-btn');

  container.innerHTML = '';

  if (!cart.length) {
    container.innerHTML = '<div class="empty-cart">سلة المشتريات فارغة</div>';
    totalPriceContainer.innerText = 'إجمالي السعر: 0 ريال';
    checkoutBtn.style.display = 'none';
    clearBtn.style.display = 'none';
    return;
  }

  checkoutBtn.style.display = 'inline-block';
  clearBtn.style.display = 'inline-block';

  const table = document.createElement('table');
  table.className = 'table cart-table';
  table.innerHTML = `
    <thead>
      <tr>
        <th>صورة</th>
        <th>المنتج</th>
        <th>السعر الفردي</th>
        <th>الكمية</th>
        <th>السعر الإجمالي</th>
        <th>حذف</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector('tbody');

  cart.forEach((item, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${item.productImage}" alt="${item.productTitle}"></td>
      <td>${item.productTitle}</td>
      <td>${item.price.toFixed(2)} ريال</td>
      <td><input type="number" class="quantity-input" value="${item.quantity}" min="1" onchange="updateQuantity(${index}, this.value)"></td>
      <td>${(item.price * item.quantity).toFixed(2)} ريال</td>
      <td><button class="btn-remove" onclick="removeItem(${index})"><i class="bi bi-trash"></i></button></td>
    `;
    tbody.appendChild(tr);
  });

  container.appendChild(table);
  updateTotal();
}

function updateQuantity(index, value) {
  const qty = parseInt(value);
  if (qty < 1) return;
  cart[index].quantity = qty;
  cart[index].totalPrice = cart[index].price * qty;
  localStorage.setItem('cart', JSON.stringify(cart));
  displayCart();
}

function removeItem(index) {
  cart.splice(index, 1);
  localStorage.setItem('cart', JSON.stringify(cart));
  displayCart();
}

function updateTotal() {
  const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
  document.getElementById('total-price').innerText = `إجمالي السعر: ${total.toFixed(2)} ريال`;
}

async function proceedToCheckout() {
  if (!cart.length) return;

  // إنشاء تفاصيل الطلب
  let orderDetails = 'طلباتي:\n';
  cart.forEach(item => {
    orderDetails += `المنتج: ${item.productTitle || item.food_name || 'منتج'}\nالكمية: ${item.quantity || 1}\nالإجمالي: ${(item.price*item.quantity).toFixed(2)} ريال\n\n`;
  });
  const totalPrice = cart.reduce((acc, item) => acc + item.price*item.quantity, 0);
  orderDetails += `الإجمالي الكلي: ${totalPrice.toFixed(2)} ريال\n`;

  try {
    // جلب رقم الواتساب من info.json
    const response = await fetch('info.json');
    const data = await response.json();
    const whatsappNumber = data.site_sections.contact?.whatsapp_number || '0507079844'; // رقم افتراضي إذا لم يوجد

    // فتح رابط واتساب مع تفاصيل الطلب
    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(orderDetails)}`;
    window.open(whatsappUrl, '_blank');
  } catch (err) {
    console.error("خطأ في جلب بيانات الاتصال:", err);
    alert("حدث خطأ أثناء محاولة فتح الواتساب.");
  }
}

function clearCart() {
  localStorage.removeItem('cart');
  cart = [];
  displayCart();
}

window.onload = displayCart;
</script>

</body>
</html>
